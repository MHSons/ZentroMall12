<script>
let discount = 0;
function formatPrice(num){ return "â‚¨"+num.toLocaleString(); }

function renderOrderSummary(){
  const container = document.getElementById("order-items");
  let subtotal = 0, html = "";
  if(!cart.length){
    container.innerHTML="<p class='text-center text-gray-500'>Cart is empty</p>";
    document.getElementById("subtotal").textContent="â‚¨0";
    document.getElementById("final-total").textContent="â‚¨0";
    document.getElementById("discount-msg").textContent="";
    return;
  }
  cart.forEach(item=>{
    const p = products.find(x => x.id === item.id);
    if(p){
      const totalItem = p.price * item.qty;
      subtotal += totalItem;
      html += `<div class="flex justify-between"><span>ðŸ›’ ${p.name} Ã— ${item.qty}</span><strong>â‚¨${totalItem.toLocaleString()}</strong></div>`;
    }
  });
  container.innerHTML = html;
  document.getElementById("subtotal").textContent = formatPrice(subtotal);
  const finalTotal = subtotal - discount;
  document.getElementById("final-total").textContent = formatPrice(finalTotal);
  document.getElementById("discount-msg").textContent = discount ? `ðŸ’¸ Discount: -â‚¨${discount.toLocaleString()}` : "";
}

function applyCoupon(){
  const code = document.getElementById("coupon").value.trim().toUpperCase();
  const msg = document.getElementById("coupon-msg");
  const subtotalValue = Number(document.getElementById("subtotal").textContent.replace(/[^0-9]/g,''));
  discount = 0;
  if(code === "ZENTRO50"){ discount = Math.round(subtotalValue*0.5); msg.textContent = "ðŸŽ‰ ZENTRO50 Applied! 50% OFF!"; }
  else if(code === "EID100"){ discount = 100000; msg.textContent = "ðŸŽ‰ EID100 Applied! â‚¨100,000 OFF!"; }
  else{ msg.textContent = "âŒ Invalid Coupon"; }
  renderOrderSummary();
}

document.getElementById("checkoutForm").addEventListener("submit", function(e){
  e.preventDefault();
  const name = document.getElementById("name").value.trim();
  let phone = document.getElementById("phone").value.trim();
  const address = document.getElementById("address").value.trim();
  if(!name || !phone || !address || cart.length === 0){ alert("âš ï¸ Please fill all fields and add items to cart!"); return; }

  phone = phone.replace(/\D/g,'');
  if(phone.startsWith("0")) phone = "92" + phone.slice(1);
  if(!/^\d{12}$/.test(phone)){ alert("âš ï¸ Invalid phone number"); return; }

  let total = 0;
  let msgText = `ðŸŒŸ *New Order from ZentroMall* ðŸŒŸ\n\nðŸ‘¤ *Customer Details:*\nâ€¢ Name: ${name}\nâ€¢ Phone: +${phone}\nâ€¢ Address: ${address}\n\nðŸ›ï¸ *Order Summary:*\n`;

  cart.forEach(item=>{
    const p = products.find(x => x.id === item.id);
    if(p){
      const itemTotal = p.price * item.qty;
      total += itemTotal;
      msgText += `â€¢ ${p.name} Ã— ${item.qty} = â‚¨${itemTotal.toLocaleString()}\n`;
    }
  });

  if(discount > 0){
    msgText += `\nðŸ’¸ *Discount Applied: â‚¨${discount.toLocaleString()}*`;
  }

  total -= discount;
  msgText += `\nðŸ’° *Total Amount: â‚¨${total.toLocaleString()}*\nðŸšš Cash on Delivery | âš¡ Fast Shipping\nðŸ™ Thank you for shopping with ZentroMall!`;

  const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  const waURL = isMobile ? 
    `https://wa.me/${phone}?text=${encodeURIComponent(msgText)}` : 
    `https://web.whatsapp.com/send?phone=${phone}&text=${encodeURIComponent(msgText)}`;

  window.open(waURL,"_blank");

  // Save order
  orders.push({
    date: new Date().toLocaleString("en-PK"),
    customer: {name, phone, address},
    items: cart.map(c => ({...c, name: products.find(p=>p.id===c.id)?.name})),
    total,
    status: "pending",
    tracking_id: ""
  });
  saveData();

  // Clear cart
  cart = [];
  localStorage.setItem("zm_cart","[]");
  updateCartCount();

  const btn = document.getElementById("submitBtn");
  btn.innerHTML = "âœ… Order Sent! Redirecting...";
  btn.classList.remove("from-green-600","to-emerald-600");
  btn.classList.add("bg-yellow-500","text-black");

  setTimeout(()=> location.href="index.html", 1500);
});

renderOrderSummary();
</script>
