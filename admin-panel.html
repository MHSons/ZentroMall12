<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - ZentroMall</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    th, td { padding: 12px; text-align: center; }
    tr:hover { background: #1e293b; }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-6" onload="checkLogin(); loadEverything()">

  <div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-5xl font-bold text-yellow-400">ADMIN PANEL</h1>
      <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-8 py-4 rounded-lg text-xl">Logout</button>
    </div>

    <!-- Tabs -->
    <div class="flex gap-4 mb-8 flex-wrap">
      <button onclick="showTab('orders')"   id="tab-orders"   class="tab-btn active px-8 py-3 rounded-lg font-bold">Orders</button>
      <button onclick="showTab('products')" id="tab-products" class="tab-btn px-8 py-3 rounded-lg font-bold">Add Product</button>
      <button onclick="showTab('banners')"  id="tab-banners"  class="tab-btn px-8 py-3 rounded-lg font-bold">Flash Banner</button>
    </div>

    <!-- === Orders Tab === -->
    <div id="orders" class="tab-content">
      <div class="bg-gray-800 rounded-2xl p-8">
        <div class="flex justify-between mb-6">
          <h2 class="text-3xl font-bold text-cyan-400">All Orders (${orders.length})</h2>
          <button onclick="exportToExcel()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-bold">Export Excel</button>
        </div>
        <input type="text" id="searchOrder" placeholder="Search by name/phone..." class="w-full p-4 rounded bg-gray-700 mb-6" onkeyup="searchOrders()">

        <div class="overflow-x-auto">
          <table class="w-full bg-gray-700 rounded-xl">
            <thead>
              <tr class="bg-gray-900">
                <th>#</th><th>Date</th><th>Name</th><th>Phone</th><th>Items</th><th>Total</th><th>Status</th><th>Tracking ID</th><th>Action</th>
              </tr>
            </thead>
            <tbody id="orderTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- === Add Product Tab === -->
    <div id="products" class="tab-content hidden">
      <div class="bg-gray-800 rounded-2xl p-8">
        <h2 class="text-3xl font-bold text-green-400 mb-6">Add New Product</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <input id="pName" placeholder="Product Name" class="p-4 rounded bg-gray-700">
          <input id="pPrice" type="number" placeholder="Price (PKR)" class="p-4 rounded bg-gray-700">
          <input id="pDesc" placeholder="Short Description" class="p-4 rounded bg-gray-700">
        </div>
        <div class="mt-4">
          <input type="file" id="pImage" accept="image/*" class="p-4 bg-gray-700 text-white w-full rounded">
        </div>
        <button onclick="addNewProduct()" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 py-5 rounded-xl text-2xl font-bold">
          ADD PRODUCT
        </button>
      </div>
    </div>

    <!-- === Banner Tab === -->
    <div id="banners" class="tab-content hidden">
      <div class="bg-gray-800 rounded-2xl p-8">
        <h2 class="text-3xl font-bold text-orange-400 mb-6">Flash Sale Banner</h2>
        <input id="bannerText" placeholder="e.g. FLASH SALE: iPhone 15 Pro – 30% OFF!" class="w-full p-4 rounded bg-gray-700 mb-4">
        <button onclick="addBanner()" class="w-full bg-green-600 hover:bg-green-700 py-4 rounded-lg font-bold">Add Banner</button>
        <div id="bannerList" class="mt-6 space-y-3"></div>
      </div>
    </div>
  </div>

  <script src="main.js"></script>
  <script>
    function checkLogin() {
      if (localStorage.getItem("zm_admin_logged") !== "true") location.href = "admin.html";
    }
    function logout() {
      localStorage.removeItem("zm_admin_logged");
      location.href = "admin.html";
    }

    function showTab(tab) {
      document.querySelectorAll(".tab-content").forEach(t => t.classList.add("hidden"));
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
      document.getElementById(tab).classList.remove("hidden");
      document.getElementById("tab-" + tab).classList.add("active");
      if (tab === "orders") loadOrders();
      if (tab === "banners") loadBanners();
    }

    function loadEverything() {
      loadOrders();
      loadBanners();
    }

    // ==================== Orders ====================
    function loadOrders() {
      const tbody = document.getElementById("orderTableBody");
      tbody.innerHTML = "";
      if (orders.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" class="text-center py-10 text-2xl text-gray-500">No orders yet</td></tr>`;
        return;
      }
      orders.slice().reverse().forEach((o, idx) => {
        const items = o.items.map(it => `${it.name} × ${it.qty}`).join("<br>");
        const realIndex = orders.length - 1 - idx;
        tbody.innerHTML += `
          <tr class="border-b border-gray-600">
            <td>${orders.length - idx}</td>
            <td>${o.date}</td>
            <td><strong>${o.customer.name}</strong></td>
            <td>${o.customer.phone}</td>
            <td class="text-left">${items}</td>
            <td class="font-bold text-yellow-400">${formatPrice(o.total)}</td>
            <td>
              <button onclick="toggleStatus(${realIndex})" class="${o.status==='complete'?'bg-green-600':'bg-yellow-600'} px-4 py-2 rounded">
                ${o.status==='complete'?'Complete':'Pending'}
              </button>
            </td>
            <td>
              <input type="text" value="${o.tracking_id||''}" onchange="updateTracking(${realIndex}, this.value)" class="bg-gray-700 px-3 py-1 rounded w-32 text-center">
            </td>
            <td>
              <button onclick="deleteOrder(${realIndex})" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded">Delete</button>
            </td>
          </tr>`;
      });
    }

    function toggleStatus(i) {
      orders[i].status = orders[i].status === "complete" ? "pending" : "complete";
      saveData(); loadOrders();
    }
    function updateTracking(i, val) {
      orders[i].tracking_id = val.trim();
      saveData();
    }
    function deleteOrder(i) {
      if(confirm("Delete this order permanently?")) {
        orders.splice(i,1);
        saveData();
        loadOrders();
      }
    }
    function searchOrders() {
      const term = document.getElementById("searchOrder").value.toLowerCase();
      const rows = document.querySelectorAll("#orderTableBody tr");
      rows.forEach(r => {
        r.style.display = r.textContent.toLowerCase().includes(term) ? "" : "none";
      });
    }

    // ==================== Excel Export ====================
    function exportToExcel() {
      if(orders.length===0) return alert("No orders to export!");
      let csv = "No,Date,Name,Phone,Address,Items,Total,Status,Tracking\n";
      orders.forEach((o,i) => {
        const items = o.items.map(it => `${it.name} x${it.qty}`).join(" | ");
        csv += `${i+1},"${o.date}","${o.customer.name}","${o.customer.phone}","${o.customer.address.replace(/"/g,'""')}","${items}","${o.total}","${o.status}","${o.tracking_id||''}"\n`;
      });
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "ZentroMall_Orders_" + new Date().toISOString().slice(0,10) + ".csv";
      link.click();
    }

    // ==================== Add Product (اب پکا سیو ہوگی) ====================
    function addNewProduct() {
      const name = document.getElementById("pName").value.trim();
      const price = Number(document.getElementById("pPrice").value);
      const desc = document.getElementById("pDesc").value.trim();
      const fileInput = document.getElementById("pImage");

      if (!name || !price || !fileInput.files[0]) {
        alert("All fields + image are required!");
        return;
      }

      handleImageUpload({target: fileInput}, imgData => {
        const newId = products.length ? Math.max(...products.map(p => p.id)) + 1 : 1;
        products.push({ id: newId, name, price, image: imgData, desc });
        saveData();
        alert("Product added successfully!");
        document.getElementById("pName").value = document.getElementById("pPrice").value = document.getElementById("pDesc").value = "";
        document.getElementById("pImage").value = "";
      });
    }

    // ==================== Banner ====================
    let banners = JSON.parse(localStorage.getItem("zm_banners") || "[]");
    function loadBanners() {
      document.getElementById("bannerList").innerHTML = banners.map((t,i) => `
        <div class="bg-gray-700 p-4 rounded flex justify-between items-center">
          <span>${t}</span>
          <button onclick="banners.splice(${i},1); localStorage.setItem('zm_banners',JSON.stringify(banners)); loadBanners();" class="bg-red-600 px-4 py-2 rounded">Delete</button>
        </div>
      `).join("") || "<p class='text-gray-500'>No banner added</p>";
    }
    function addBanner() {
      const txt = document.getElementById("bannerText").value.trim();
      if(txt) {
        banners.push(txt);
        localStorage.setItem("zm_banners", JSON.stringify(banners));
        document.getElementById("bannerText").value = "";
        loadBanners();
      }
    }
  </script>
</body>
</html>
