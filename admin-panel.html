<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel – ZentroMall</title>
  <link rel="icon" href="logo.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Noto Nastaliq Urdu', sans-serif; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid gray; padding: 12px; text-align: right; }
    th { background: #1e293b; }
    .hover-row:hover { background: #334155; }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4" onload="checkAdminAccess(); loadOrders();">

  <div class="max-w-6xl mx-auto">
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-4xl font-bold text-yellow-400">ایڈمن پینل</h1>
      <button onclick="logoutAdmin()" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg">لاگ آؤٹ</button>
    </div>

    <!-- Orders History -->
    <div class="bg-gray-800 rounded-2xl p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-bold text-green-400">تمام آرڈرز کی ہسٹری</h2>
        <input type="text" id="searchOrder" placeholder="نام, فون یا تاریخ سرچ کریں" class="p-3 rounded bg-gray-700 w-64 text-white" onkeyup="searchOrders()">
        <button onclick="exportToExcel()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg ml-4">Excel Export</button>
      </div>

      <div class="overflow-x-auto">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>تاریخ/وقت</th>
              <th>کسٹمر کا نام</th>
              <th>فون نمبر</th>
              <th>ایڈریس</th>
              <th>پروڈکٹس</th>
              <th>کل بل</th>
              <th>سٹیٹس</th>
              <th>ٹریکنگ ID</th>
              <th>ایکشنز</th>
            </tr>
          </thead>
          <tbody id="orderTableBody">
            <!-- Orders Here -->
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <script src="main.js"></script>
  <script>
    function checkAdminAccess() {
      if (localStorage.getItem("zm_admin_logged") !== "true") {
        alert("لاگین کریں!");
        location.href = "admin.html";
      }
    }

    function logoutAdmin() {
      localStorage.removeItem("zm_admin_logged");
      location.href = "admin.html";
    }

    function loadOrders() {
      const tbody = document.getElementById("orderTableBody");
      tbody.innerHTML = "";
      orders.forEach((order, index) => {
        const itemsList = order.items.map(it => `${it.name} × ${it.qty}`).join("<br>");
        tbody.innerHTML += `
          <tr class="hover-row">
            <td>${orders.length - index}</td>
            <td>${order.date}</td>
            <td>${order.customer.name}</td>
            <td>${order.customer.phone}</td>
            <td>${order.customer.address}</td>
            <td>${itemsList}</td>
            <td class="font-bold text-green-400">${formatPrice(order.total)}</td>
            <td id="status-${index}" class="font-bold ${order.status === 'complete' ? 'text-green-400' : 'text-yellow-400'}">
              ${order.status || 'pending'}
            </td>
            <td id="tracking-${index}">
              ${order.tracking_id || 'N/A'}
            </td>
            <td class="flex gap-2">
              <button onclick="toggleStatus(${index})" class="bg-blue-600 px-3 py-1 rounded">
                ${order.status === 'complete' ? 'Pending' : 'Complete'}
              </button>
              <button onclick="addTracking(${index})" class="bg-purple-600 px-3 py-1 rounded">
                Tracking ID Add
              </button>
              <button onclick="deleteOrder(${index})" class="bg-red-600 px-3 py-1 rounded">
                Delete
              </button>
            </td>
          </tr>`;
      });
      if (orders.length === 0) {
        tbody.innerHTML = `<tr><td colspan="10" class="text-center py-8 text-gray-400 text-2xl">کوئی آرڈر نہیں</td></tr>`;
      }
    }

    function toggleStatus(index) {
      orders[index].status = orders[index].status === 'complete' ? 'pending' : 'complete';
      saveData();
      loadOrders();
    }

    function addTracking(index) {
      const tracking = prompt("ٹریکنگ ID درج کریں (جیسے TCS نمبر):");
      if (tracking) {
        orders[index].tracking_id = tracking;
        saveData();
        loadOrders();
      }
    }

    function deleteOrder(index) {
      if (confirm("یہ آرڈر ڈیلیٹ کریں؟")) {
        orders.splice(index, 1);
        saveData();
        loadOrders();
      }
    }

    function searchOrders() {
      const term = document.getElementById("searchOrder").value.toLowerCase();
      const rows = document.querySelectorAll("#orderTableBody tr");
      rows.forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(term) ? "" : "none";
      });
    }

    function exportToExcel() {
      if (orders.length === 0) return alert("کوئی آرڈر نہیں!");

      let csv = 'ID,Date,Name,Phone,Address,Products,Total,Status,Tracking ID\n';

      orders.forEach((order, i) => {
        const items = order.items.map(it => `${it.name} x ${it.qty}`).join(' | ');
        csv += `${i+1},"${order.date}","${order.customer.name}","${order.customer.phone}","${order.customer.address.replace(/"/g, '""')}", "${items.replace(/"/g, '""')}",${order.total},${order.status || 'pending'},"${order.tracking_id || ''}"\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "zentromall_orders.csv"; // Excel mein open hoga
      link.click();
      URL.revokeObjectURL(url);
    }

  </script>
</body>
</html>
